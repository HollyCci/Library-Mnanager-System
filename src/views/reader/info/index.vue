<template>
	<n-space :vertical="true" :size="16">
		<!-- <div
			class="hover:-translate-y-2 group bg-neutral-50 duration-500 w-44 h-44 flex text-neutral-600 flex-col justify-center items-center relative rounded-xl overflow-hidden shadow-md"
		>
			<svg
				viewBox="0 0 200 200"
				xmlns="http://www.w3.org/2000/svg"
				class="absolute blur z-10 fill-red-300 duration-500 group-hover:blur-none group-hover:scale-105"
			>
				<path
					transform="translate(100 100)"
					d="M39.5,-49.6C54.8,-43.2,73.2,-36.5,78.2,-24.6C83.2,-12.7,74.8,4.4,69,22.5C63.3,40.6,60.2,59.6,49.1,64.8C38.1,70,19,61.5,0.6,60.7C-17.9,59.9,-35.9,67,-47.2,61.9C-58.6,56.7,-63.4,39.5,-70,22.1C-76.6,4.7,-84.9,-12.8,-81.9,-28.1C-79,-43.3,-64.6,-56.3,-49.1,-62.5C-33.6,-68.8,-16.8,-68.3,-2.3,-65.1C12.1,-61.9,24.2,-55.9,39.5,-49.6Z"
				></path>
			</svg>

			<div class="z-20 flex flex-col justify-center items-center">
				<span class="font-bold text-6xl ml-2">34+</span>
				<p class="font-bold">Projects</p>
			</div>
		</div> -->

		<n-card title="æˆ‘çš„ä¿¡æ¯" :bordered="false" size="small" class="rounded-8px shadow-sm" hoverable>
			<n-card :bordered="false" class="rounded-8px shadow-sm">
				<div class="flex-y-center justify-between">
					<div class="flex-y-center">
						<icon-local-avatar class="text-70px"/>
						<div class="pl-12px">
							<h3 class="text-18px font-semibold">
								{{ userInfo ? userInfo.nickname + 'æ‚¨å¥½ï¼Œ' + titleTip : 'æš‚æ— æ˜µç§°' }}
							</h3>
							<n-flex>
								<n-tag :bordered="false" size="small" class="tag tag-primary border">
									{{ userInfo && userInfo.dept.name ? userInfo.dept.name : 'æš‚æ— å­¦é™¢ä¿¡æ¯' }}
								</n-tag>
								<n-tag :bordered="false" size="small" class="tag tag-primary border">
									{{ userInfo && userInfo.sclass.name ? userInfo.sclass.name : 'æš‚æ— ç­çº§ä¿¡æ¯' }}
								</n-tag>
							</n-flex>
						</div>
					</div>
					<n-space :size="24" :wrap="false">
						<n-statistic
							label="å€Ÿé˜…é¢åº¦"
							:value="userInfo && userInfo.borrowCount ? userInfo.borrowCount - userInfo.borrowedCount : 0"
						>
							<template #prefix>
								<n-icon>
									<icon-fluent:person-available-20-regular class="text-28px mb2"/>
								</n-icon>
							</template>
							<template #suffix>
								<n-text>/ {{ userInfo.borrowCount ? userInfo.borrowCount : 0 }}</n-text>
							</template>
						</n-statistic>
					</n-space>
				</div>
			</n-card>

			<!-- <t-list-item>
				<t-list-item-meta :image="userInfo.avatar ? userInfo.avatar : 'https://tdesign.gtimg.com/site/avatar.jpg'">
					<template #title>
						{{ userInfo ? userInfo.nickname + 'åŒå­¦æ‚¨å¥½ï¼Œ' + titleTip : 'æš‚æ— æ˜µç§°' }}
					</template>
					<template #description>
						<n-grid :x-gap="50" :y-gap="8" :cols="8">
							<n-gi>
								<t-tooltip content="æ‰€å±å­¦é™¢" theme="light">
									<icon-uil:university class="text-24px mb0.9 mr2" />
								</t-tooltip>
								<t-tag theme="primary">
									{{ userInfo && userInfo.dept.name ? userInfo.dept.name : 'æš‚æ— å­¦é™¢ä¿¡æ¯' }}
								</t-tag>
							</n-gi>
							<n-gi span="3">
								<t-tooltip content="æ‰€å±ç­çº§" theme="light">
									<icon-healthicons:i-training-class-outline class="text-28px mr2" />
								</t-tooltip>
								<t-tag theme="primary">
									{{ userInfo && userInfo.sclass.name ? userInfo.sclass.name : 'æš‚æ— ç­çº§ä¿¡æ¯' }}
								</t-tag>
								<t-tooltip content="å‰©ä½™å€Ÿé˜…é¢åº¦/å€Ÿé˜…é¢åº¦" theme="light">
									<icon-fluent:person-available-20-regular class="text-28px mr2 ml16" />
								</t-tooltip>
								<t-tag theme="primary">
									{{
										userInfo && userInfo.borrowCount
											? userInfo.borrowCount - userInfo.borrowedCount
											: 'æš‚æ— æ¶ˆè´¹é¢åº¦ä¿¡æ¯'
									}}/{{ userInfo && userInfo.borrowCount ? userInfo.borrowCount : 'æš‚æ— å€Ÿé˜…é¢åº¦ä¿¡æ¯' }}
								</t-tag>
							</n-gi>
							<n-gi>
								<t-tooltip content="å¾…å–å›¾ä¹¦" theme="light">
									<icon-guidance:waiting-room class="text-26px mr2 ml3" />
								</t-tooltip>
								<t-tag theme="primary">
									å¾…å–ï¼š{{ userInfo && userInfo.waitTakeCount !== null ? userInfo.waitTakeCount : 'null' }}
								</t-tag>
							</n-gi>

							<n-gi>
								<t-tooltip content="å³å°†é€¾æœŸå›¾ä¹¦æ€»æ•°" theme="light">
									<icon-flat-color-icons:overtime class="text-26px mr2" />
								</t-tooltip>
								<t-tag theme="primary">
									å³å°†é€¾æœŸï¼š{{ userInfo && userInfo.soonOverdueCount !== null ? userInfo.soonOverdueCount : 'null' }}
								</t-tag>
							</n-gi>

							<n-gi>
								<t-tooltip content="é€¾æœŸå›¾ä¹¦æ€»æ•°" theme="light">
									<icon-ri:pass-expired-line class="text-26px mr2" />
								</t-tooltip>
								<t-tag theme="warning">
									é€¾æœŸä¸­ï¼š{{ userInfo && userInfo.overdueCount !== null ? userInfo.overdueCount : 'null' }}
								</t-tag>
							</n-gi>
							<n-gi>
								<t-tooltip content="å·²å½’è¿˜å›¾ä¹¦æ€»æ•°" theme="light">
									<icon-material-symbols:assignment-returned-outline class="text-26px mr2" />
								</t-tooltip>
								<t-tag theme="primary">
									å·²å½’è¿˜ï¼š{{ userInfo && userInfo.overReturnCount !== null ? userInfo.overReturnCount : 'null' }}
								</t-tag>
							</n-gi>
						</n-grid>
					</template>
				</t-list-item-meta>
			</t-list-item> -->
		</n-card>

		<n-card title="æˆ‘çš„å€Ÿé˜…" :bordered="false" size="small" class="rounded-8px shadow-sm" hoverable>
			<n-tabs type="line" default-value="all" @update:value="handleUpdateValue">
				<n-tab-pane name="all" tab="å…¨éƒ¨è®°å½•"/>
				<n-tab-pane name="approve" tab="å¾…å–è®°å½•"/>
				<n-tab-pane name="borrowing" tab="å€Ÿé˜…ä¸­"/>
				<n-tab-pane name="renewal" tab="å®¡æ‰¹é©³å›"/>
				<n-tab-pane name="due" tab="å³å°†é€¾æœŸ"/>
				<n-tab-pane name="planning" tab="é¢„å®šè®°å½•"/>
				<n-tab-pane name="overdue" tab="é€¾æœŸè®°å½•"/>
				<n-tab-pane name="return" tab="å½’è¿˜è®°å½•"/>
			</n-tabs>
			<n-spin :show="dataLoading">
				<transition name="fade-slide" mode="out-in" :appear="true">
					<n-flex>
						<d-card v-for="borrow in borrowedList" :key="borrow.id" v-ripple="{ duration: 500 }" style="width: 380px">
							<template #avatar>
								<d-avatar name="DevUI"/>
							</template>
							<template #title>
								<n-text>{{ borrow.book.title }}</n-text>
							</template>
							<template #subtitle>
								<n-flex>
									<n-text>{{ borrow.book.author }}</n-text>
									<d-tag v-if="borrow.status === 0 || borrow.status === 2" size="18">
										<icon-svg-spinners:180-ring-with-bg class="text-16px mb1 mr1" color="#0052d9"/>
										<n-text type="success" style="color: #0052d9">å®¡æ‰¹ä¸­</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === 1" size="18">
										<icon-svg-spinners:pulse-multiple class="text-18px mb1 mr1" color="#007d65"/>
										<n-text type="success" style="color: #007d65">å¾…å–ä¹¦</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === 3" size="18">
										<icon-svg-spinners:bouncing-ball class="text-18px mb1 mr1" color="#0052d9"/>
										<n-text type="success" style="color: #0052d9">å€Ÿé˜…ä¸­</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === 4" size="18">
										<icon-svg-spinners:bouncing-ball class="text-18px mb1 mr1" color="#e37318"/>
										<n-text type="success" style="color: #e37318">å³å°†åˆ°æœŸ</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === 5" size="18">
										<icon-icon-park-twotone:success class="text-16px mb1 mr1" color="#18a058"/>
										<n-text type="success">å·²å½’è¿˜</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === -1" size="18">
										<icon-streamline:interface-validation-check-circle-checkmark-addition-circle-success-check-validation-add-form
											class="text-14px mb1 mr1"
											color="#d03050"
										/>
										<n-text type="success" style="color: #d03050">å®¡æ‰¹é©³å›</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === -2" size="18">
										<icon-svg-spinners:pulse-3 class="text-14px mb1 mr1" color="#d03050"/>
										<n-text type="success" style="color: #d03050">é€¾æœŸä¸­</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === -3" size="18">
										<icon-mdi:archive-success-outline class="text-16px mb1 mr1" color="#18a058"/>
										<n-text type="success" style="color: #18a058">é€¾æœŸå½’è¿˜</n-text>
									</d-tag>
									<d-tag v-if="borrow.status === 6" size="18">
										<icon-svg-spinners:180-ring-with-bg class="text-16px mb1 mr1" color="#18a058"/>
										<n-text type="success" style="color: #18a058">é¢„å®šä¸­</n-text>
									</d-tag>
								</n-flex>
							</template>
							<template #content>
								<n-flex vertical>
									<n-flex>
										<n-tag round :bordered="false">
											<n-text>{{ borrow.barCode }}</n-text>
											<template #avatar>
												<icon-ion:barcode-outline class="text-20px m1"/>
											</template>
										</n-tag>
										<n-tag round :bordered="false">
											<n-text>{{ borrow.bookStack.stackName }}</n-text>
											<template #avatar>
												<icon-fa6-solid:warehouse class="text-16px m1"/>
											</template>
										</n-tag>
									</n-flex>
									<n-tag round :bordered="false" class="text-14px">
										<n-text>{{ borrow.serialNumber }}</n-text>
										<template #avatar>
											<icon-carbon:order-details class="text-20px m1"/>
										</template>
									</n-tag>
									<n-tag round :bordered="false" class="text-14px">
										<n-text>{{ formatDate(borrow.borrowTime) }} - {{ formatDate(borrow.expectReturnTime) }}</n-text>
										<template #avatar>
											<icon-formkit:datetime class="text-20px m1"/>
										</template>
									</n-tag>
								</n-flex>
							</template>
							<template #actions>
								<n-flex>
									<n-button size="small" @click="handleToBorrowDetail(borrow.serialNumber)">æŸ¥çœ‹è¯¦æƒ…</n-button>
									<n-button
										v-if="borrow.status === 1"
										size="small"
										type="success"
										@click="handleTakeBook(borrow.id, borrow.serialNumber, borrow.book.title)"
									>
										æˆ‘å·²å–å¾—
									</n-button>
									<n-button
										v-if="borrow.status === 4 || borrow.status === 3"
										size="small"
										type="warning"
										@click="handleRenewalBook(borrow.id, borrow.serialNumber, borrow.book.title)"
									>
										ç”³è¯·ç»­æœŸ
									</n-button>
									<n-button
										v-if="borrow.status === -2 || borrow.status === 4 || borrow.status === 3"
										type="info"
										size="small"
										@click="handleReturnBook(borrow.id, borrow.serialNumber, borrow.book.title)"
									>
										å½’è¿˜å›¾ä¹¦
									</n-button>
								</n-flex>
							</template>
						</d-card>
					</n-flex>
				</transition>

				<n-empty
					v-if="!(borrowedList && borrowedList.length > 0 && !dataLoading)"
					description="ä»€ä¹ˆä¹Ÿæ²¡æœ‰æ‰¾åˆ°"
				></n-empty>
			</n-spin>
			<n-pagination
				:page="queryParams.pageNo"
				:page-size="queryParams.pageSize"
				:page-count="pageCount"
				:on-update:page="handlePageUpdate"
				class="mt3"
			>
				<template #prefix>å…± {{ itemCount }} é¡¹</template>
			</n-pagination>
		</n-card>
		<n-modal v-model:show="formShow" transform-origin="center">
			<n-card style="width: 600px" title="ç»­å€Ÿå›¾ä¹¦" :bordered="false" size="huge" role="dialog" aria-modal="true">
				<n-form ref="formRef" :rules="rules" :model="renewalFormData" label-placement="left" label-width="93px">
					<n-form-item label="å›¾ä¹¦åç§°" required>
						<n-input v-model:value="renewalFormData.title" disabled style="width: 80%"></n-input>
					</n-form-item>
					<n-form-item label="å€Ÿé˜…å•å·" required>
						<n-input v-model:value="renewalFormData.serialNumber" disabled style="width: 80%"></n-input>
					</n-form-item>
					<n-form-item label="æ–°å½’è¿˜æ—¶é—´" path="newReturnTime" required>
						<n-date-picker
							v-model:value="renewalFormData.newReturnTime"
							type="datetime"
							placeholder="è¯·é€‰æ‹©å½’è¿˜æ—¶é—´"
							:is-date-disabled="isDateDisabled"
							:shortcuts="shortcuts"
							placement="bottom-end"
							style="width: 80%"
						>
							<template #footer>åŒå­¦åˆç†å®‰æ’å€Ÿé˜…æ—¶é—´å“¦ğŸ§¡</template>
						</n-date-picker>
					</n-form-item>
					<n-form-item label="ç»­å€ŸåŸå› " path="remark" required>
						<n-input
							v-model:value="renewalFormData.remark"
							type="textarea"
							placeholder="è¯·è¾“å…¥ç»­å€ŸåŸå› "
							:autosize="{
                minRows: 3,
                maxRows: 5
              }"
							style="width: 80%"
						/>
					</n-form-item>
				</n-form>
				<template #footer>
					<n-space style="float: right">
						<n-button type="primary" @click="submitFrom">ç¡® å®š</n-button>
						<n-button @click="close">å– æ¶ˆ</n-button>
					</n-space>
				</template>
			</n-card>
		</n-modal>
	</n-space>
</template>

<script setup lang="tsx">
/* eslint-disable */
import {ref, reactive, onMounted} from 'vue'; // å¯¼å…¥ Vue Composition API ä¸­çš„å‡½æ•°
import type {FormRules} from 'naive-ui'; // å¯¼å…¥ Naive UI ä¸­çš„ä¸€äº›ç±»å‹
import {routeName} from '@/router';
import {useRouterPush} from '@/composables'; // å¯¼å…¥å›¾ä¹¦ SKU ç›¸å…³çš„ API è°ƒç”¨
import * as ReaderApi from '@/service/api/reader'; // å¯¼å…¥è¯»è€…ç›¸å…³çš„ API è°ƒç”¨
import * as UserProfilesApi from '@/service/api/userProfile'; // å¯¼å…¥ç”¨æˆ·ç›¸å…³çš„ API è°ƒç”¨
import {formatDate} from '@/utils/common/formatTime';

const {routerPush} = useRouterPush();
const queryParams = reactive({
	status: undefined as number | undefined,
	pageNo: 1,
	pageSize: 12
});
const pageCount = ref(0);
const itemCount = ref(0);
const dataLoading = ref(false);

const borrowedList = ref<any>([]);

const userInfo = ref<any>({
	id: undefined,
	username: '',
	nickname: '',
	avatar: '',
	dept: {
		id: undefined,
		name: ''
	},
	sclass: {
		id: undefined,
		name: ''
	},
	borrowedCount: 0,
	countOverRead: 0,
	countWaitTake: 0,
	countSoonOverdue: 0,
	countOverReturn: 0,
	borrowCount: 0,
	roles: [],
	posts: [],
	socialUser: [],
	email: '',
	mobile: '',
	sex: undefined,
	status: undefined,
	remark: '',
	loginIp: '',
	loginDate: '',
	createTime: ''
});

const titleTip = ref('');

const encourageRead = [
	'å°‘å¹´åº”æœ‰é¸¿é¹„å¿—ï¼Œå½“éª‘éªé©¬è¸å¹³å·',
	'é²œè¡£æ€’é©¬å°‘å¹´æ—¶ï¼Œä¸è´ŸéŸ¶åè¡Œä¸”çŸ¥',
	'æ—¶äººä¸è¯†å‡Œäº‘æœ¨ï¼Œç›´å¾…å‡Œäº‘å§‹é“é«˜',
	'çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ',
	'å°‘å¹´æ˜“è€å­¦éš¾æˆï¼Œä¸€å¯¸å…‰é˜´ä¸å¯è½»',
	'å¤äººå­¦é—®æ— é—åŠ›ï¼Œå°‘å£®å·¥å¤«è€å§‹æˆ',
	'ç²—ç¼¯å¤§æ­¥è£¹å¤©æ¶¯ï¼Œè…¹æœ‰è¯—ä¹¦æ°”è‡ªå',
	'è¹‰è·è«é£éŸ¶å…‰è€ï¼Œäººç”Ÿå”¯æœ‰è¯»ä¹¦å¥½',
	'åŠ›å­¦å¦‚åŠ›è€•ï¼Œå‹¤æƒ°å°”è‡ªå¦‚'
];

const loveRead = [
	'è¯»ä¹¦çš„ç›®çš„ï¼Œä¸åœ¨äºå–å¾—å¤šå¤§æˆå°±ï¼Œè€Œåœ¨äºï¼Œå½“ä½ è¢«ç”Ÿæ´»æ‰“å›åŸå½¢ï¼Œé™·å…¥æ³¥æ½­æ—¶ï¼Œç»™ä½ ä¸€ç§å†…åœ¨çš„åŠ›é‡ã€‚',
	'å°‘å¹´è¯»ä¹¦å¦‚éš™ä¸­çª¥æœˆï¼Œä¸­å¹´è¯»ä¹¦å¦‚åº­ä¸­æœ›æœˆï¼Œè€å¹´è¯»ä¹¦å¦‚å°ä¸Šç©æœˆï¼Œçš†ä»¥é˜…å†ä¹‹æµ…æ·±ä¸ºæ‰€å¾—ä¹‹æµ…æ·±è€³ã€‚',
	'æˆ‘å§‹ç»ˆç›¸ä¿¡æˆ‘è¯»è¿‡çš„æ‰€æœ‰ä¹¦éƒ½ä¸ä¼šç™½è¯»ï¼Œå®ƒæ€»ä¼šåœ¨æœªæ¥æ—¥å­çš„æŸä¸€ä¸ªåœºåˆå¸®åŠ©æˆ‘è¡¨ç°å¾—æ›´å‡ºè‰²ï¼Œè¯»ä¹¦æ˜¯å¯ä»¥ç»™äººä»¥åŠ›é‡çš„ï¼Œå®ƒèƒ½ç»™äººå¿«ä¹',
	'è¯»ä¹¦å¤šäº†ï¼Œå®¹é¢œè‡ªç„¶æ”¹å˜ã€‚è®¸å¤šæ—¶å€™è‡ªå·±å¯èƒ½ä»¥ä¸ºè®¸å¤šçœ‹è¿‡çš„ä¹¦ç±éƒ½æˆè¿‡çœ¼çƒŸäº‘ï¼Œä¸å¤è®°å¿†ï¼Œå…¶å®ä»–ä»¬ä»æ˜¯æ½œåœ¨çš„ã€‚åœ¨æ°”è´¨é‡Œï¼Œåœ¨è°ˆåä¸Šï¼Œåœ¨èƒ¸è¥Ÿçš„æ— æ¶¯ã€‚å½“ç„¶ä¹Ÿèƒ½æ˜¾éœ²åœ¨ç”Ÿæ´»å’Œæ–‡å­—ä¸­ã€‚',
	'ä¹¦è¯»å¾—è¶Šå¤šè€Œä¸å‡æ€ç´¢ï¼Œä½ å°±ä¼šè§‰å¾—ä½ çŸ¥é“å¾—å¾ˆå¤šï¼›è€Œå½“ä½ è¯»ä¹¦è€Œæ€è€ƒå¾—è¶Šå¤šçš„æ—¶å€™ï¼Œä½ å°±ä¼šæ¸…æ¥šåœ°çœ‹åˆ°ï¼Œä½ çŸ¥é“å¾—è¿˜å¾ˆå°‘ã€‚',
	'è¯»ä¹¦ä¸æ˜¯ä¸ºäº†æ‹¿æ–‡å‡­æˆ–è€…å‘è´¢ï¼Œè€Œæ˜¯æˆä¸ºä¸€ä¸ªæœ‰æ¸©åº¦æ‡‚æƒ…ç»ªä¼šæ€è€ƒçš„äººã€‚',
	'å¹´è½»çš„æ—¶å€™ä»¥ä¸ºä¸è¯»ä¹¦ä¸è¶³ä»¥äº†è§£äººç”Ÿï¼Œç›´åˆ°åæ¥æ‰å‘ç°ï¼Œå¦‚æœä¸äº†è§£äººç”Ÿï¼Œæ˜¯è¯»ä¸æ‡‚ä¹¦çš„ã€‚è¯»ä¹¦çš„æ„ä¹‰å¤§æ¦‚å°±æ˜¯ç”¨ç”Ÿæ´»æ‰€æ„Ÿå»è¯»ä¹¦ï¼Œç”¨è¯»ä¹¦æ‰€å¾—å»ç”Ÿæ´»ã€‚',
	'è¯»ä¹¦ä¸æ˜¯ä¸ºäº†é›„è¾©å’Œé©³æ–¥ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†è½»ä¿¡å’Œç›²ä»ï¼Œè€Œæ˜¯ä¸ºäº†æ€è€ƒå’Œæƒè¡¡',
	'å…³å…³éš¾è¿‡å…³å…³è¿‡ï¼Œå‰é€”ç¿ç¿äº¦æ»¡æ»¡ã€‚'
];

const getUserInfo = async () => {
	const {data} = await UserProfilesApi.getUserProfile();
	// @ts-ignore
	userInfo.value = data;
	if (data !== null && data.nickname !== null) {
		if (data.overReadCount >= 1) {
			titleTip.value = `æ‚¨å·²ç»é˜…è¯»äº† ${data.overReadCount} æœ¬ä¹¦ï¼Œä¸é”™çš„æˆç»©ï¼`;
		}
		if (data.overReadCount === 0) {
			// éšæœºä»encourageReadè·å–ä¸€ä¸ª
			titleTip.value = `${encourageRead[Math.floor(Math.random() * encourageRead.length)]}ã€‚å¿«å¼€å§‹å€Ÿé˜…ç¬¬ä¸€æœ¬ä¹¦æŠŠï¼`;
		}
	}

	// éšæœºä»loveReadè·å–ä¸€ä¸ª
	window.$message?.info(loveRead[Math.floor(Math.random() * loveRead.length)], {
		showIcon: false,
		closable: true,
		duration: 8000
	});
};

const formShow = ref(false);
const formRef = ref();
const renewalFormData = ref({
	id: 0,
	serialNumber: '',
	title: '',
	newReturnTime: null,
	remark: ''
});

const isDateDisabled = (ts: number) => {
	const selectedDate = new Date(ts);
	const currentDate = new Date();
	currentDate.setHours(0, 0, 0, 0); // é‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º0ï¼Œåªæ¯”è¾ƒæ—¥æœŸ

	const maxSelectableDate = new Date();
	maxSelectableDate.setDate(currentDate.getDate() + 30); // è®¾ç½®æœ€å¤§å¯é€‰æ‹©æ—¥æœŸä¸ºä»Šå¤©åŠ ä¸Š30å¤©

	return selectedDate < currentDate || selectedDate > maxSelectableDate;
};

const shortcuts = {
	'7å¤©': () => new Date().getTime() + 24 * 60 * 60 * 1000 * 7,
	'15å¤©': () => new Date().getTime() + 24 * 60 * 60 * 1000 * 15,
	'30å¤©': () => new Date().getTime() + 24 * 60 * 60 * 1000 * 30
};

const getUserBorrowInfo = async () => {
	dataLoading.value = true;
	const {data} = await ReaderApi.getReaderBorrowPage(queryParams);
	borrowedList.value = data.list;
	itemCount.value = data.total;
	pageCount.value = Math.ceil(itemCount.value / queryParams.pageSize);
	dataLoading.value = false;
}

const getUserOverdueBorrowInfo = async () => {
	restQueryParams();
	dataLoading.value = true;
	const {data} = await ReaderApi.getReaderOverDueBorrowPage(queryParams);
	borrowedList.value = data.list;
	itemCount.value = data.total;
	pageCount.value = Math.ceil(itemCount.value / queryParams.pageSize);
	dataLoading.value = false;
}

const getUserReturnedBorrowInfo = async () => {
	restQueryParams();
	dataLoading.value = true;
	const {data} = await ReaderApi.getReaderReturnedBorrowPage(queryParams);
	borrowedList.value = data.list;
	itemCount.value = data.total;
	pageCount.value = Math.ceil(itemCount.value / queryParams.pageSize);
	dataLoading.value = false;
}

const getUserBorrowInfoByTabs = async (status: number) => {
	restQueryParams();
	queryParams.status = status;
	await getUserBorrowInfo();
}

const handlePageUpdate = (page: number) => {
	queryParams.pageNo = page;
	getUserBorrowInfo();
};

const handleReturnBook = async (id: number, serialNumber: string, title: string) => {
	const data = {
		id,
		serialNumber
	} as unknown as ReaderApi.borrowReturnReqVO;
	window.$dialog?.info({
		title: 'å›¾ä¹¦å½’è¿˜',
		content: `æ‚¨ç¡®å®šè¦å½’è¿˜çš„å›¾ä¹¦æ˜¯ï¼šã€Š${title}ã€‹å—ï¼Ÿ`,
		positiveText: 'ç¡®å®š',
		negativeText: 'å–æ¶ˆ',
		onPositiveClick: async () => {
			const res = await ReaderApi.returnReaderBorrowBook(data);
			if (res.data === true) {
				window.$message?.success(`å›¾ä¹¦${title}å½’è¿˜æˆåŠŸï¼`);
			}
			await getUserBorrowInfo();
		}
	});
};

const handleTakeBook = async (id: number, serialNumber: string, title: string) => {
	const param = {
		id,
		serialNumber
	} as unknown as ReaderApi.borrowReturnReqVO;
	window.$dialog?.info({
		title: 'å›¾ä¹¦é¢†å–',
		content: `æ‚¨ç¡®å®šå·²ç»é¢†å–äº†å›¾ä¹¦ï¼šã€Š${title}ã€‹å—ï¼Ÿ`,
		positiveText: 'ç¡®å®š',
		negativeText: 'å–æ¶ˆ',
		onPositiveClick: async () => {
			const {data} = await ReaderApi.verifyTakeBook(param);
			if (data === true) {
				window.$message?.success(`å›¾ä¹¦${title}å–ä¹¦æˆåŠŸï¼`);
			}
			await getUserBorrowInfo();
		}
	});
};

const handleRenewalBook = async (id: number, serialNumber: string, title: string) => {
	renewalFormData.value.id = id;
	renewalFormData.value.serialNumber = serialNumber;
	renewalFormData.value.title = title;
	formShow.value = true;
};

const handleUpdateValue = async (tabName: string) => {
	switch (tabName) {
		case 'all':
			restQueryParams();
			getUserBorrowInfo();
			break;
		case 'approve':
			await getUserBorrowInfoByTabs(1);
			break;
		case 'borrowing':
			await getUserBorrowInfoByTabs(3);
			break;
		case 'renewal':
			await getUserBorrowInfoByTabs(-1);
			break;
		case 'due':
			await getUserBorrowInfoByTabs(4);
			break;
		case 'planning':
			await getUserBorrowInfoByTabs(6);
			break;
		case 'overdue':
			await getUserOverdueBorrowInfo();
			break;
		case 'return':
			await getUserReturnedBorrowInfo();
			break;
	}
}

const restQueryParams = () => {
	queryParams.status = undefined;
	queryParams.pageNo = 1;
	queryParams.pageSize = 12;
}
const rules: FormRules = {
	newReturnTime: [{type: 'number', required: true, trigger: ['blur', 'change'], message: 'è¯·é€‰æ‹©å½’è¿˜æ—¶é—´'}]
};

const close = () => {
	formShow.value = false;
	renewalFormData.value.newReturnTime = null;
	renewalFormData.value.remark = '';
};

async function submitFrom() {
	if (!formRef.value) return;
	await formRef.value.validate;

	try {
		const param = renewalFormData.value as unknown as ReaderApi.renewalBookReqVO;
		const {data} = await ReaderApi.renewalBook(param);
		if (data === true) {
			window.$message?.success(`å›¾ä¹¦${renewalFormData.value.title}ç»­å€ŸæˆåŠŸï¼Œè¯·åŒå­¦åˆç†å®‰æ’é˜…è¯»æ—¶é—´~`);
		}
	} finally {
		getUserBorrowInfo();
		close();
	}
}

const handleToBorrowDetail = (serialNumber: string) => {
	routerPush({name: routeName('reader_borrow-detail'), query: {serialNumber}});
};

onMounted(async () => {
	// è·å–ç”¨æˆ·ä¿¡æ¯
	await getUserInfo();
	// è·å–ç”¨æˆ·å€Ÿé˜…ä¿¡æ¯
	await getUserBorrowInfo();
});
</script>
<style scoped>
.tag {
	color: aliceblue;
	margin: 0;
	font-size: 12px;
	height: 24px;
	display: inline-flex;
	box-sizing: border-box;
	flex-direction: row;
	align-items: center;
	border: 3px solid transparent;
	white-space: nowrap;
	font-family: 'Ping Fang SC', 'Microsoft YaHei', 'Helvetica', 'Arial', sans-serif;
}

.tag-primary {
	background-color: #0052d9;
}
</style>
